<!DOCTYPE html>
<html>
<head>
	<title>SailPoint Returns | A Thoma Bravo Investment</title>
	<meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover'>
	<link rel="stylesheet" href="main.css">
	<!-- Favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
	<link rel="manifest" href="manifest.json">
	<link rel="mask-icon" href="safari-pinned-tab.svg" color="#052365">
	<meta name="theme-color" content="#052365">

	<!-- Web App Titles -->
	<meta name="apple-mobile-web-app-title" content="SailPoint Returns">
	<meta name="application-name" content="SailPoint Returns">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="apple-touch-startup-image" href="./images/thoma_bravo-logo.png">

	<!-- Facebook Open Graph -->
	<meta property="og:image" content="https://tinfelise.github.io/sailpoint/images/images/sharing.jpg">

</head>
<body>
	<header>
		<a href='https://finance.yahoo.com/quote/sail' target='blank_'>
			<img class='logo' src='./images/sailpoint-logo.png' alt='SailPoint'>
		</a>
		<div>
			<span id='ticker'></span>
			<span id='updated'></span>
		</div>
		<button onclick="reload()">
			<i class="fa fa-refresh" aria-hidden="true"></i>
		</button>
	</header>
	<main>
		<div class='loader'>
			<svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
			    viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">
			  <path  d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">
			    <animateTransform attributeType="xml"
			      attributeName="transform"
			      type="rotate"
			      from="0 25 25"
			      to="360 25 25"
			      dur="0.6s"
			      repeatCount="indefinite"/>
			    </path>
			  </svg>
		</div>
		<section id='stockData'>
			<div>
				<h1 id='current_price'></h1>
				<div id='price_changes'>
					<h3>
						<span id='compared_to_yesterday'></span> 
						<span id='compared_to_yesterday_perc'></span> 
						<span id='previous_weekday'></span>
					</h3>
				</div>
			</div>
			<h3 id='market_cap'></h3>
			<h3 id='enterprise_value'></h3>
			<div id='revenues'></div>
		</section>
		<section id='ownership'>
			<img class='logo' src='./images/thoma_bravo-logo.png' alt='Thoma Bravo'>
			<h3 id='TB_shares'></h3>
			<h3 id='TB_shares_perc'></h3>
			<h3 id='TB_shares_value'></h3>
			<h3 id='IRR'></h3>
		</section>
		<section id='returns'>
			
			<div>
				<span>Realized</span>
				<div id='realized'></div>	
			</div>
			<div>
				<span>Unrealized</span>
				<div id='unrealized'></div>
			</div>
			<div>
				<span>Total Returns</span>
				<div id='total_gains'></div>
			</div>
		</section>
	</main>
	<footer>
		<!-- <a id='AlphaVantage' target='blank_'>See raw data</a> -->
	</footer>
	<!-- Libraries -->
	<script src="https://use.fontawesome.com/1727fd84aa.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/financejs@4.1.0/finance.js"></script>
	<!-- Javascript -->
	<script src="spreadsheet_data.js"></script>

</body>
</html>

<script>
	
	var finance = new Finance();
	var million = 1000000;

	var stock_data = {};
	var current_price, previous_close;

	var realized, unrealized;
	var all_realizations = [];

	var current_TB_shares, fdso;
	
	function get_stock_price (ticker) {
		var alphavantage_key = 'B67FR48WBLNMCCHH';
		var path = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=' + ticker +
		'&apikey=' + alphavantage_key;
		var settings = {
			url: path,
			beforeSend: function () {
				console.log('Fetching stock data from...')
				console.log(path);
				$('#ticker').html(ticker);
				// $('#AlphaVantage').attr('href', path);
			},
			error: function () {
				no_data();
			},
			success: function (data) {
				parse_stock_data(data);
			}
		};
		$.ajax(settings)
	};
	function reset () {
		all_realizations = [];
	};
	function reload () {
		$('body').removeClass('loaded');
		reset();
		get_stock_price('SAIL');
	};

	function no_data () {
		console.log('AlphaVantage did not return data.');
		$('main').addClass('loaded');
		$('#stockData .data').html('<h1>Data unavailable</h1><span>Please try again later</span>');
	};

	function previous_market_day(date, date_format) {
		var day_before = moment(date, date_format).subtract(1, 'days');
		var day_of_week = moment(day_before).format('E');
		if (day_of_week > 5) {
			var offset = day_of_week - 5;
			day_before = moment(day_before, date_format).subtract(offset, 'days');
		};
		return moment(day_before).format('YYYY-MM-DD');
	};
	function display_update_time (date, time, open) {
		var html = 'As of ';
		if (open) {
			var date_time = date + ' ' + time;
			html += moment(date_time, 'YYYY-MM-DD LTS').format('h:mmA');
		} else {
			var exchange_open = moment('9:30 AM -05:00', 'LT Z');
			var exchange_close = moment('4:00 PM -05:00', 'LT Z');
			if ( moment().isBetween(exchange_open, exchange_close) == false ) {
				html += 'closing ';
			}
			html += moment(date, 'YYYY-MM-DD').format('MMM. Do');
		};
		$('#updated').html(html);
	};
	function previous_day_of_week (date) {
		var days_ago = moment(date).diff(moment(), 'days');
		var weekday = 'yesterday';
		if (days_ago != -1) {
			weekday = moment(date).format('dddd');
		};
		$('#previous_weekday').html('from ' + weekday);
	};

	function parse_stock_data (data) {
		var meta_data = data['Meta Data'];
		var markets_open = false;
		var last_updated = '3. Last Refreshed';
			last_updated = meta_data[last_updated];
		console.log('As of ' + last_updated);

		var last_updated_date = last_updated;
		if ( last_updated.split(' ').length > 1 ) {
			markets_open = true;
			last_updated_date = last_updated.split(' ')[0];
			var last_updated_time = last_updated.split(' ')[1];
				last_updated_time = last_updated_time + '-05:00'; // EST timezone offset
		};

		display_update_time(last_updated_date, last_updated_time, markets_open);

		stock_data = data['Time Series (Daily)'];

		var previous = previous_market_day(last_updated_date, 'YYYY-MM-DD');
		previous_day_of_week(moment(previous, 'YYYY-MM-DD'));

		var todays_data = stock_data[last_updated_date];
		var yesterdays_data = stock_data[previous];

		var close = '4. close';
		current_price = todays_data[close];
		previous_close = yesterdays_data[close];

		do_the_math(current_price, previous_close);
	};

	function percentage_change (current, previous) {
		var diff = current - previous;
		var percentage_change = diff/previous;
			percentage_change = numeral(percentage_change).format('%0.00');
		return percentage_change;
	};

	function get_IRR (realizations) {
		var amounts = [];
		var dates = [];
		for (i in realizations) {
			amounts[i] = realizations[i].amount * million;
			var date = moment(realizations[i].date, 'MM/DD/YY');
			var year = moment(date).format('YYYY');
			var month = moment(date).format('MM');
			var day = moment(date).format('DD');
			dates[i] = new Date(year, month, day);
		};
		var XIRR = finance.XIRR(amounts, dates) / 100;
		$('#IRR').html( numeral(XIRR).format('0,0[.]0%') + ' <span>IRR</span>' );
	};
	function order_events (events, format) {
		events = events.sort(function (a, b) {
	    	return moment(a.date, format).format('x')
	    		.localeCompare(
	    			moment(b.date, format).format('x')
				);
		});
	};
	function add_new_realizations (array) {
		for (obj in array) {
			all_realizations.push(array[obj]);
		};
		order_events(all_realizations, 'MM/DD/YY');
	};
	function calc_MoM (gains) {
		return gains / (-purchase.amount * million);
	};
	function calc_unrealized(share_value) {
		unrealized = share_value;
		var IPO_mark = {
			'event': 'IPO Mark',
			'date': moment().format('MM/DD/YY'),
			'amount': (share_value / million)
		};
		add_new_realizations([IPO_mark,purchase]);
		get_IRR(all_realizations);
	};
	function calc_realized(realizations) {
		realized = 0;
		for (i in realizations) {
			realized += realizations[i].amount * million;
		};
	};
	function compile_realizations () {
		// all_realizations.length = [];
		for (i in preIPO_realizations) {
			var realization = preIPO_realizations[i];
			all_realizations.push(realization);
		};
		for (i in postIPO_realizations) {
			var realization = postIPO_realizations[i];
			var obj = {};
				obj.event = realization.event;
				obj.date = realization.date;
				obj.amount = realization.shares * realization.stock_price;
			all_realizations.push(obj);
		};
		calc_realized(all_realizations);
	};

	function get_TB_shares_perc (TB_shares, total_shares) {
		var TB_shares_perc = TB_shares / (total_shares * million);
		var html = numeral(TB_shares_perc).format('0[.]0%') + ' <span>Stake</span>';
		$('#TB_shares_perc').html(html);
	};
	function get_TB_shares_value (shares) {
		$('#TB_shares').html( numeral(shares).format('0.0a') + ' <span>Shares</span>' );
		var TB_shares_value = shares * current_price;
		$('#TB_shares_value').html( numeral(TB_shares_value).format('$0.0a') + ' <span>Value</span>' );
		calc_unrealized(TB_shares_value);
	};
	function get_TB_ownership (realizations) {
		var total_sold = 0;
		for (i in realizations) {
			var realization = realizations[i];
			var shares = realization.shares;
			total_sold += shares;
		};
		current_TB_shares = (TB_preIPO_shares - total_sold) * million;
		get_TB_shares_value(current_TB_shares);
	};
	function total_gains_MoM (realizations) {
		compile_realizations();
		get_TB_ownership(realizations);
		
		var total_gains = realized + unrealized;
		var total_MoM = calc_MoM(total_gains);

		$('#realized').html('<h2>' + numeral(realized).format('$0,0[.]0a') + '</h2>');
		$('#realized').append('<div class="MoM"><span>' + numeral( calc_MoM(realized) ).format('0[.]00') + 'x</span> MoM</div>');

		$('#unrealized').html('<h2>' + numeral(unrealized).format('$0,0[.]0a') + '</h2>');
		$('#unrealized').append('<div class="MoM"><span>' + numeral( calc_MoM(unrealized) ).format('0[.]00') + 'x</span> MoM</div>');

		$('#total_gains').html('<h2>' + numeral(total_gains).format('$0,0[.]0a') + '</h2>');
		$('#total_gains').append('<div class="MoM"><span>' + numeral( calc_MoM(total_gains) ).format('0[.]00') + 'x</span> MoM</div>');
	};
	function get_revenue_multiples (enterprise_value) {
		var html = '';
		for (i in revenues) {
			var multiple = enterprise_value / (revenues[i] * million);
			html += '<h3 class="multiple">'
					+ numeral(multiple).format('0.00') + 'x'
					+ ' <span>' + i + ' Revenues</span>'
					+ '</h3>';
		};
		$('#revenues').html(html);
	};
	function get_enterprise_value (market_cap) {
		var enterprise_value = market_cap + (net_debt * million);
		$('#enterprise_value').html(numeral(enterprise_value).format('($0.00a)') + ' <span>Enterprise Value</span>');
		get_revenue_multiples(enterprise_value);
	};
	function get_market_cap (RSUs) {
		fdso = 0;
		for (i in share_count_build) {
			fdso += share_count_build[i];
		};
		fdso += RSUs;
		var market_cap = fdso * current_price * million;
		$('#market_cap').html(numeral(market_cap).format('($0.00a)') + ' <span>Market Cap</span>');
		get_enterprise_value(market_cap);
	};
	function dilute_shares(options) {
		var RSUs_Options = 0;
		for (issuance in options_build) {
			var strike_price = options_build[issuance].strike;
			var shares = options_build[issuance].shares;
			var diluted = 0;
			if (current_price > strike_price) {
				diluted = (current_price - strike_price)/current_price*shares;
			};
			RSUs_Options += diluted;
		};
		get_market_cap(RSUs_Options);
	};

	function do_the_math (current_price, price_yesterday) {
		var compared_to_yesterday = current_price - price_yesterday;
		var stock_class = 'up';
		if (compared_to_yesterday < 0) {
			stock_class = 'down';
		};
		var compared_to_yesterday_perc = percentage_change(current_price,price_yesterday);

		$('body').addClass('loaded');
		$('#current_price').html( numeral(current_price).format('$0,0.00') );
		$('#price_changes').addClass(stock_class);
		$('#compared_to_yesterday').html( numeral(compared_to_yesterday).format('$0,0[.]00') );
		$('#compared_to_yesterday_perc').html('(' + compared_to_yesterday_perc + ')');

		dilute_shares(options_build);
		total_gains_MoM(postIPO_realizations);
		get_TB_shares_perc(current_TB_shares, fdso);
	};

	// do_the_math(15.33, 14.71);
	get_stock_price('SAIL');

</script>