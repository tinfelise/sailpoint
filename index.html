<!DOCTYPE html>
<html>
<head>
	<title>SailPoint Returns | Thoma Bravo Investment</title>
	<meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover'>
	<link rel="stylesheet" href="main.css">
	<!-- Favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
	<link rel="manifest" href="manifest.json">
	<link rel="mask-icon" href="safari-pinned-tab.svg" color="#052365">
	<meta name="theme-color" content="#052365">
</head>
<body>
	<header></header>
	<main>
		<section id='stockData'>
			<a href='https://finance.yahoo.com/quote/sail' target='blank_'>
				<img class='logo' src='./images/sailpoint-logo.png' alt='SailPoint'>
			</a>
			<div class='data'>
				<span id='ticker'></span>
				<h1 id='current_price'></h1>
				<div><span id='compared_to_yesterday'></span> <span id='compared_to_yesterday_perc'></span></div>
				<div id='market_cap'></div>
				<div id='enterprise_value'></div>
				<button onclick="reload()">Reload</button>
			</div>
			<div class='loader'>
				<svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
				     width="40px" height="40px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">
				  <path  d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">
				    <animateTransform attributeType="xml"
				      attributeName="transform"
				      type="rotate"
				      from="0 25 25"
				      to="360 25 25"
				      dur="0.6s"
				      repeatCount="indefinite"/>
				    </path>
				  </svg>
			</div>
		</section>
		<section id='ownership'>
			<img class='logo' src='./images/thoma_bravo-logo.png' alt='Thoma Bravo'>
			<div id='TB_shares'></div>
			<div id='TB_shares_value'></div>
		</section>
		<section id='returns'></section>
	</main>
	<footer>
		<!-- <a id='AlphaVantage' target='blank_'>See raw data</a> -->
	</footer>
	<!-- Libraries -->
	<script src="https://use.fontawesome.com/1727fd84aa.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>

</body>
</html>

<script>
	// var today = moment().format('YYYY-MM-DD');
	// var day_of_week = moment().format('E');
	// var yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD');
	// if (day_of_week > 5) {
	// 	var offset = day_of_week - 5;
	// 	today = moment(today).subtract(offset, 'days').format('YYYY-MM-DD');
	// 	yesterday = moment(yesterday).subtract(offset, 'days').format('YYYY-MM-DD');
	// } else if (day_of_week == 1) {
	// 	yesterday = moment(yesterday).subtract(2, 'days').format('YYYY-MM-DD');
	// };

	var million = 1000000;

	var stock_data = {};
	var current_price, yesterdays_close;
	
	function get_stock_price (ticker) {
		var alphavantage_key = 'B67FR48WBLNMCCHH';
		var path = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=' + ticker +
		'&apikey=' + alphavantage_key;
		var settings = {
			url: path,
			beforeSend: function () {
				console.log('Fetching stock data from...')
				console.log(path);
				$('#ticker').html(ticker);
				// $('#AlphaVantage').attr('href', path);
			},
			error: function () {
				no_data();
			},
			success: function (data) {
				parse_stock_data(data);
			}
		};
		$.ajax(settings)
	};
	function reload () {
		$('main').removeClass('loaded');
		get_stock_price('SAIL');
	};

	function no_data () {
		console.log('AlphaVantage did not return data.');
		$('main').addClass('loaded');
		$('#stockData .data').html('<h1>Data unavailable</h1><span>Please try again later</span>');
	};

	function previous_market_day(date, date_format) {
		var day_before = moment(date, date_format).subtract(1, 'days');
		var day_of_week = moment(day_before).format('E');
		if (day_of_week > 5) {
			var offset = day_of_week - 5;
			day_before = moment(day_before, date_format).subtract(offset, 'days');
		};
		return moment(day_before).format('YYYY-MM-DD');
	};

	function parse_stock_data (data) {
		var meta_data = data['Meta Data'];
		var markets_open = false;
		var last_updated = '3. Last Refreshed';
			last_updated = meta_data[last_updated];
		console.log('As of ' + last_updated);

		var last_updated_date = last_updated;
		if ( last_updated.split(' ').length > 1 ) {
			markets_open = true;
			last_updated_date = last_updated.split(' ')[0];
			var last_updated_time = last_updated.split(' ')[1];
		};
		stock_data = data['Time Series (Daily)'];

		var previous = previous_market_day(last_updated_date, 'YYYY-MM-DD');

		var todays_data = stock_data[last_updated_date];
		var yesterdays_data = stock_data[previous];

		var close = '4. close';
		current_price = todays_data[close];
		yesterdays_close = yesterdays_data[close];

		do_the_math(current_price, yesterdays_close);
	};

	function percentage_change (current, previous) {
		var diff = current - previous;
		var percentage_change = diff/previous;
			percentage_change = numeral(percentage_change).format('%0.00');
		return percentage_change;
	};

	var options_build = [
		{
			'tranche': 1,
			'strike': 0,
			'shares': 0.825,
		},
		{
			'tranche': 2,
			'strike': 2.67242,
			'shares': 2.462434,
		}
	];

	var share_count_build = {
		'Basic Shares': 50.8951089662646,
		'Pref-Shares': 20.4993953808417,
		'IPO Shares': 14.3,
		'Greenshoe Shares': 1.5
	};

	var postIPO_realizations = [
		{
			'event':'Sold @ IPO',
			'date': '11/22/17',
			'shares':  6.5,
			'stock_price': 12*(1-.07)
		}
	];

	var TB_preIPO_shares = 56.8170170175447;

	var revenues = {
		'2018': 216.083759525813,
		'2019': 270
	};
	var net_debt = -30.4295;

	function get_TB_ownership (shares) {
		$('#TB_shares').html('<span>' + numeral(shares).format('0.0a') + '</span> Thoma Bravo Shares');
		var TB_shares_value = shares * current_price;
		$('#TB_shares_value').html('<span>' + numeral(TB_shares_value).format('$0.0a') + '</span> Value');
	};
	function add_realizations (realizations) {
		var total_sold = 0;
		for (i in realizations) {
			var realization = realizations[i];
			var shares = realization.shares;
			total_sold += shares;
		};
		var current_TB_shares = (TB_preIPO_shares - total_sold) * million;
		get_TB_ownership(current_TB_shares);
	};
	function get_revenue_multiples (enterprise_value) {
		for (i in revenues) {
			var multiple = enterprise_value / (revenues[i] * million);
			var html = '<div class="multiple">';
				html += '<span>' + numeral(multiple).format('0.00') + 'x' + '</span>';
				html += ' ' + i + ' Revenues</div>'
			$('#enterprise_value').append(html);
		};
	};
	function get_enterprise_value (market_cap) {
		var enterprise_value = market_cap + (net_debt * million);
		$('#enterprise_value').html(numeral('<span>' + enterprise_value).format('($0.00a)') + '</span> Enterprise Value');
		get_revenue_multiples(enterprise_value);
	};
	function get_market_cap (RSUs) {
		var fdso = 0;
		for (i in share_count_build) {
			fdso += share_count_build[i];
		};
		fdso += RSUs;
		var market_cap = fdso * current_price * million;
		$('#market_cap').html('<span>' + numeral(market_cap).format('($0.00a)') + '</span> Market Cap');
		get_enterprise_value(market_cap);
	};
	function dilute_shares(options) {
		var RSUs_Options = 0;
		for (issuance in options_build) {
			var strike_price = options_build[issuance].strike;
			var shares = options_build[issuance].shares;
			var diluted = 0;
			if (current_price > strike_price) {
				diluted = (current_price - strike_price)/current_price*shares;
			};
			RSUs_Options += diluted;
		};
		get_market_cap(RSUs_Options);
	};

	function do_the_math (current_price, price_yesterday) {
		var compared_to_yesterday = numeral(current_price - price_yesterday).format('0,0.00');
		var compared_to_yesterday_perc = percentage_change(current_price,price_yesterday);

		$('main').addClass('loaded')
		$('#current_price').html( numeral(current_price).format('$0,0.00') );
		$('#compared_to_yesterday').html(compared_to_yesterday);
		$('#compared_to_yesterday_perc').html('(' + compared_to_yesterday_perc + ')');

		dilute_shares(options_build);
		add_realizations(postIPO_realizations);
	};

	// do_the_math(15.33, 14.71);
	get_stock_price('SAIL');

</script>